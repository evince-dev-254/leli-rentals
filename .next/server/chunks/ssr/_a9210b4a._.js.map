{"version":3,"sources":["../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../lib/supabase-admin.ts","../../../../.next-internal/server/app/%28auth%29/signup/page/actions.js%20%28server%20actions%20loader%29","../../../../lib/actions/verify-actions.ts","../../../../components/emails/otp-email.tsx","../../../../lib/actions/auth-actions.ts"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","import { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n\r\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n    }\r\n})\r\n","export {sendWelcomeEmail as '60eb1c4f17aa689bd417ddf6139ff5290a11f54209'} from 'ACTIONS_MODULE0'\nexport {sendCustomOtp as '4075bbdb2ca7d6dbe0c38be9664ddb06adfa49638c'} from 'ACTIONS_MODULE1'\nexport {verifyCustomOtp as '78c519256122260b30e4eaeb7222d35a71686cc0a3'} from 'ACTIONS_MODULE1'\nexport {registerUser as '402ae546aed102d64769f54943c332ada2d9deff94'} from 'ACTIONS_MODULE2'\n","\"use server\"\r\n\r\nimport { supabaseAdmin } from \"@/lib/supabase-admin\"\r\nimport { resend } from \"@/lib/resend\"\r\nimport OtpEmail from \"@/components/emails/otp-email\"\r\n\r\nexport async function sendCustomOtp(email: string) {\r\n    const code = Math.floor(100000 + Math.random() * 900000).toString()\r\n\r\n    // Store code in user_profiles metadata or update a field\r\n    // We can use a temporary table 'verifications' or just store in an allowed field.\r\n    // Since we don't have a verifications table for this, let's use user_profiles 'phone' field as a hack? No.\r\n    // Let's create a 'verification_code' column in user_profiles via SQL later.\r\n    // For now, we'll store it in the user's app_metadata using Admin API which persists on auth.users.\r\n\r\n    // OPTION: Update auth.users user_metadata (or app_metadata which is safer)\r\n\r\n    // First, find user ID\r\n    const { data: { users }, error: findError } = await supabaseAdmin.auth.admin.listUsers()\r\n    if (findError) return { success: false, error: findError.message }\r\n\r\n    const user = users.find(u => u.email === email)\r\n    if (!user) return { success: false, error: \"User not found\" }\r\n\r\n    const { error: updateError } = await supabaseAdmin.auth.admin.updateUserById(\r\n        user.id,\r\n        { user_metadata: { ...user.user_metadata, custom_otp: code, custom_otp_sent_at: new Date().toISOString() } }\r\n    )\r\n\r\n    if (updateError) return { success: false, error: updateError.message }\r\n\r\n    // Send Email\r\n    try {\r\n        console.log(`[DEV ONLY] Generated OTP for ${email}: ${code}`); // Log for dev/sandbox use\r\n\r\n        const data = await resend.emails.send({\r\n            from: \"Leli Rentals <onboarding@leli.rentals>\",\r\n            to: email,\r\n            subject: \"Your Verification Code\",\r\n            react: OtpEmail({ code }),\r\n        })\r\n\r\n        if (data.error) {\r\n            console.error('Resend API Error:', data.error);\r\n            // If it's the sandbox limitation, we still want to allow the flow if they can read the logs\r\n            if (data.error.message?.includes(\"only send testing emails to your own email address\")) {\r\n                console.warn(\"⚠️ RESEND SANDBOX LIMITATION: You can only send to your verified email. The OTP has been logged above for your convenience.\");\r\n                // Return success so the UI moves to the OTP input step, allowing them to enter the code from the console\r\n                return { success: true };\r\n            }\r\n            return { success: false, error: data.error.message }\r\n        }\r\n\r\n        return { success: true }\r\n    } catch (err: any) {\r\n        console.error('Email sending failed:', err);\r\n        return { success: false, error: err.message }\r\n    }\r\n}\r\n\r\nexport async function verifyCustomOtp(email: string, code: string, password?: string, fullName?: string) {\r\n    // Find user\r\n    const { data: { users }, error: findError } = await supabaseAdmin.auth.admin.listUsers()\r\n    if (findError) return { success: false, error: findError.message }\r\n\r\n    const user = users.find(u => u.email === email)\r\n    if (!user) return { success: false, error: \"User not found\" }\r\n\r\n    const storedOtp = user.user_metadata?.custom_otp\r\n    // const sentAt = user.user_metadata?.custom_otp_sent_at // Could check expiry\r\n\r\n    if (storedOtp === code) {\r\n        // Construct updates\r\n        const updates: any = {\r\n            email_confirm: true,\r\n            user_metadata: { ...user.user_metadata, custom_otp: null }\r\n        }\r\n\r\n        // If password is provided, force update it (handles stale/existing user case)\r\n        if (password) {\r\n            updates.password = password\r\n        }\r\n\r\n        // Ensure full_name is set if provided\r\n        if (fullName) {\r\n            updates.user_metadata.full_name = fullName\r\n        }\r\n\r\n        // Confirm Email & Update Password!\r\n        const { error: confirmError } = await supabaseAdmin.auth.admin.updateUserById(\r\n            user.id,\r\n            updates\r\n        )\r\n\r\n        if (confirmError) return { success: false, error: confirmError.message }\r\n\r\n        return { success: true }\r\n    } else {\r\n        return { success: false, error: \"Invalid code\" }\r\n    }\r\n}\r\n","import {\r\n    Body,\r\n    Container,\r\n    Head,\r\n    Heading,\r\n    Html,\r\n    Img,\r\n    Preview,\r\n    Section,\r\n    Text,\r\n    Tailwind,\r\n} from \"@react-email/components\"\r\nimport * as React from \"react\"\r\n\r\ninterface OtpEmailProps {\r\n    code: string\r\n}\r\n\r\nconst baseUrl = process.env.NEXT_PUBLIC_APP_URL || \"\"\r\n\r\nexport const OtpEmail = ({ code }: OtpEmailProps) => {\r\n    return (\r\n        <Html>\r\n            <Head />\r\n            <Preview>Your Verification Code: {code}</Preview>\r\n            <Tailwind\r\n                config={{\r\n                    theme: {\r\n                        extend: {\r\n                            colors: {\r\n                                brand: \"#ea580c\",\r\n                            },\r\n                        },\r\n                    },\r\n                }}\r\n            >\r\n                <Body className=\"bg-white my-auto mx-auto font-sans\">\r\n                    <Container className=\"border border-solid border-[#eaeaea] rounded my-[40px] mx-auto p-[20px] w-[465px]\">\r\n                        <Section className=\"mt-[32px]\">\r\n                            <Img\r\n                                src={`${baseUrl}/logo.png`}\r\n                                width=\"120\"\r\n                                height=\"32\"\r\n                                alt=\"Leli Rentals\"\r\n                                className=\"my-0 mx-auto\"\r\n                            />\r\n                        </Section>\r\n                        <Heading className=\"text-black text-[24px] font-normal text-center p-0 my-[30px] mx-0\">\r\n                            Verify Your Account\r\n                        </Heading>\r\n                        <Text className=\"text-black text-[14px] leading-[24px]\">\r\n                            Here is your verification code to complete your signup:\r\n                        </Text>\r\n                        <Section className=\"bg-slate-100 p-[20px] rounded text-center my-[20px]\">\r\n                            <Text className=\"text-black text-[32px] font-bold tracking-[6px] m-0\">\r\n                                {code}\r\n                            </Text>\r\n                        </Section>\r\n                        <Text className=\"text-black text-[14px] leading-[24px] text-center\">\r\n                            This code will expire in 10 minutes.\r\n                        </Text>\r\n                    </Container>\r\n                </Body>\r\n            </Tailwind>\r\n        </Html>\r\n    )\r\n}\r\n\r\nexport default OtpEmail\r\n","\"use server\"\r\n\r\nimport { supabaseAdmin } from \"@/lib/supabase-admin\"\r\n\r\nexport async function registerUser({ email, password, data }: { email: string, password: string, data: any }) {\r\n    try {\r\n        // Use Admin API to create user without sending confirmation email\r\n        const { data: user, error } = await supabaseAdmin.auth.admin.createUser({\r\n            email,\r\n            password,\r\n            email_confirm: false, // User is NOT confirmed yet\r\n            user_metadata: data\r\n        })\r\n\r\n        if (error) {\r\n            console.error('Admin create user error:', error)\r\n            return { success: false, error: error.message }\r\n        }\r\n\r\n        return { success: true, user: user.user }\r\n    } catch (error: any) {\r\n        console.error('Registration error:', error)\r\n        return { success: false, error: error.message || 'Registration failed' }\r\n    }\r\n}\r\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"6CAAoD,OAAA,cAAA,CAAA,EAAA,aAAA,oCAC3CA,0BAAAA,qCAAAA,EAAAA,uBAAuB,YAAQ,CAAA,CAAA,IAAA,iCCEjC,SAASC,EAAyBC,CAAc,EACrD,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAQE,MAAM,CAAED,IAAK,CACvC,IAAME,EAASH,CAAO,CAACC,EAAE,CACzB,GAAsB,YAAlB,AAA8B,OAAvBE,EACT,MAAM,OAAA,cAEL,CAFK,AAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,EAAO;AAAA,oEAAuE,CAAC,EADhJ,oBAAA,OAAA,mBAAA,gBAAA,CAEN,EAEJ,CACF,0EATgBJ,2BAAAA,qCAAAA,6BCHhB,IAAA,EAAA,EAAA,CAAA,CAAA,OAGA,IAAM,EAAyB,QAAQ,GAAG,CAAC,yBAAyB,CAEvD,EAAgB,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,AAHpC,2CAGiD,EAAwB,CAC3E,KAAM,CACF,kBAAkB,EAClB,gBAAgB,CACpB,CACJ,sDCVA,IAAA,EAAA,EAAA,CAAA,CAAA,oBCEA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,mBCHA,EAAA,EAAA,CAAA,CAAA,MAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,KAAA,EAAA,EAAA,CAAA,CAAA,MAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,oBDMO,eAAe,EAAc,CAAa,EAC7C,IAAM,EAAO,KAAK,KAAK,CAAC,IAAyB,IAAhB,KAAK,MAAM,IAAa,QAAQ,GAW3D,CAAE,KAAM,OAAE,CAAK,CAAE,CAAE,MAAO,CAAS,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,GACtF,GAAI,EAAW,MAAO,CAAE,SAAS,EAAO,MAAO,EAAU,OAAO,AAAC,EAEjE,IAAM,EAAO,EAAM,IAAI,CAAC,GAAK,EAAE,KAAK,GAAK,GACzC,GAAI,CAAC,EAAM,MAAO,CAAE,SAAS,EAAO,MAAO,gBAAiB,EAE5D,GAAM,CAAE,MAAO,CAAW,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,cAAc,CACxE,EAAK,EAAE,CACP,CAAE,cAAe,CAAE,GAAG,EAAK,aAAa,CAAE,WAAY,EAAM,mBAAoB,IAAI,OAAO,WAAW,EAAG,CAAE,GAG/G,GAAI,EAAa,MAAO,CAAE,QAAS,GAAO,MAAO,EAAY,OAAO,AAAC,EAGrE,GAAI,CACA,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,EAAM,EAAE,EAAE,EAAA,CAAM,EAE5D,CAF+D,GAEzD,EAAO,MAAM,EAAA,MAAM,CAAC,MAF+D,AAEzD,CAAC,IAAI,CAAC,CAClC,KAAM,yCACN,GAAI,EACJ,QAAS,yBACT,MAAO,ACnBK,EAAC,MAAE,CAAI,CAAiB,GAExC,CAAA,EAAA,EAAA,IAAA,EAAC,EAAA,IAAI,CAAA,WACD,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAA,GACL,CAAA,EAAA,EAAA,IAAA,EAAC,EAAA,OAAO,CAAA,WAAC,2BAAyB,KAClC,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,QAAQ,CAAA,CACL,OAAQ,CACJ,MAAO,CACH,OAAQ,CACJ,OAAQ,CACJ,MAAO,SACX,CACJ,CACJ,CACJ,WAEA,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAC,UAAU,8CACZ,CAAA,EAAA,EAAA,IAAA,EAAC,EAAA,SAAS,CAAA,CAAC,UAAU,8FACjB,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAO,CAAA,CAAC,UAAU,qBACf,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,GAAG,CAAA,CACA,IAAK,GAAG,QAAQ,SAAS,CAAC,YAC1B,MAAM,MACN,OAAO,KACP,IAAI,eACJ,UAAU,mBAGlB,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAO,CAAA,CAAC,UAAU,6EAAoE,wBAGvF,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAC,UAAU,iDAAwC,4DAGxD,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAO,CAAA,CAAC,UAAU,+DACf,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAC,UAAU,+DACX,MAGT,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,IAAI,CAAA,CAAC,UAAU,6DAAoD,kDAQ5F,ED3B4B,MAAE,CAAK,EAC3B,GAEA,GAAI,EAAK,KAAK,CAAE,CAGZ,GAFA,QAAQ,KAAK,CAAC,oBAAqB,EAAK,KAAK,EAEzC,EAAK,KAAK,CAAC,OAAO,EAAE,SAAS,sDAG7B,CAHoF,MACpF,QAAQ,IAAI,CAAC,+HAEN,CAAE,SAAS,CAAK,EAE3B,MAAO,CAAE,SAAS,EAAO,MAAO,EAAK,KAAK,CAAC,OAAO,AAAC,CACvD,CAEA,MAAO,CAAE,QAAS,EAAK,CAC3B,CAAE,MAAO,EAAU,CAEf,OADA,QAAQ,KAAK,CAAC,wBAAyB,GAChC,CAAE,SAAS,EAAO,MAAO,EAAI,OAAO,AAAC,CAChD,CACJ,CAEO,eAAe,EAAgB,CAAa,CAAE,CAAY,CAAE,CAAiB,CAAE,CAAiB,EAEnG,GAAM,CAAE,KAAM,CAAE,OAAK,CAAE,CAAE,MAAO,CAAS,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,GACtF,GAAI,EAAW,MAAO,CAAE,SAAS,EAAO,MAAO,EAAU,OAAO,AAAC,EAEjE,IAAM,EAAO,EAAM,IAAI,CAAC,GAAK,EAAE,KAAK,GAAK,GACzC,GAAI,CAAC,EAAM,MAAO,CAAE,SAAS,EAAO,MAAO,gBAAiB,EAK5D,GAHkB,AAGd,EAHmB,aAAa,EAAE,aAGpB,EA2Bd,MAAO,CAAE,SAAS,EAAO,MAAO,cAAe,CA3B3B,EAEpB,IAAM,EAAe,CACjB,eAAe,EACf,cAAe,CAAE,GAAG,EAAK,aAAa,CAAE,WAAY,IAAK,CAC7D,EAGI,IACA,EAAQ,IADE,IACM,CAAG,CAAA,EAInB,IACA,EAAQ,IADE,SACW,CAAC,SAAS,CAAG,CAAA,EAItC,GAAM,CAAE,MAAO,CAAY,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,cAAc,CACzE,EAAK,EAAE,CACP,UAGJ,AAAI,EAAqB,CAAE,SAAS,EAAlB,AAAyB,MAAO,EAAa,OAAO,AAAC,EAEhE,CAAE,SAAS,CAAK,CAC3B,CAGJ,CEhGO,KF6FI,UE7FW,EAAa,OAAE,CAAK,UAAE,CAAQ,MAAE,CAAI,CAAkD,EACxG,GAAI,CAEA,GAAM,CAAE,KAAM,CAAI,CAAE,OAAK,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,OACpE,WACA,EACA,eAAe,EACf,cAAe,CACnB,GAEA,GAAI,EAEA,KAFO,EACP,QAAQ,KAAK,CAAC,2BAA4B,GACnC,CAAE,QAAS,GAAO,MAAO,EAAM,OAAQ,AAAD,EAGjD,MAAO,CAAE,SAAS,EAAM,KAAM,EAAK,IAAI,AAAC,CAC5C,CAAE,MAAO,EAAY,CAEjB,OADA,QAAQ,KAAK,CAAC,sBAAuB,GAC9B,CAAE,SAAS,EAAO,MAAO,EAAM,OAAO,EAAI,qBAAsB,CAC3E,CACJ,iCFlBsB,EAsDA,IAtDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAsDA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,sCExDA,IAAA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA","ignoreList":[0,1]}