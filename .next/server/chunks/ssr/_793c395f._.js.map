{"version":3,"sources":["../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../lib/supabase-admin.ts","../../../../lib/actions/affiliate-actions.ts","../../../../.next-internal/server/app/admin/affiliates/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","import { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\r\nconst supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n\r\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey, {\r\n    auth: {\r\n        autoRefreshToken: false,\r\n        persistSession: false\r\n    }\r\n})\r\n","\"use server\"\r\n\r\nimport { supabase } from \"@/lib/supabase\"\r\nimport { supabaseAdmin } from \"@/lib/supabase-admin\"\r\n\r\n// ... existing joinAffiliateProgram ...\r\n\r\nexport async function getAllAffiliates() {\r\n    const { data, error } = await supabaseAdmin\r\n        .from('affiliates')\r\n        .select(`\r\n            *,\r\n            user_profiles:user_id (\r\n                full_name,\r\n                email,\r\n                avatar_url,\r\n                account_status\r\n            )\r\n        `)\r\n        .order('created_at', { ascending: false })\r\n\r\n    if (error) {\r\n        console.error('Error fetching all affiliates:', error)\r\n        return []\r\n    }\r\n\r\n    return data\r\n}\r\n\r\n\r\nexport async function joinAffiliateProgram(userId: string, email: string) {\r\n    // 1. Check if affiliate already exists for this user or email\r\n    const { data: existingAffiliate, error: findError } = await supabaseAdmin\r\n        .from('affiliates')\r\n        .select('*')\r\n        .or(`user_id.eq.${userId},email.eq.${email}`)\r\n        .single();\r\n\r\n    if (existingAffiliate) {\r\n        // Already exists, just ensure role is updated and return success\r\n        // Update user role to affiliate if not already\r\n        await supabaseAdmin\r\n            .from('user_profiles')\r\n            .update({ role: 'affiliate' })\r\n            .eq('id', userId);\r\n\r\n        return { success: true, data: existingAffiliate };\r\n    }\r\n\r\n    // Generate codes\r\n    const inviteCode = Math.random().toString(36).substring(2, 10).toUpperCase();\r\n    const referralCode = `REF-${inviteCode}`;\r\n\r\n    // Create affiliate record using Admin client to bypass RLS\r\n    const { data, error } = await supabaseAdmin\r\n        .from('affiliates')\r\n        .insert({\r\n            user_id: userId,\r\n            email: email,\r\n            invite_code: inviteCode,\r\n            referral_code: referralCode,\r\n            status: 'active', // Auto-activate\r\n            commission_rate: 10.00\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error joining affiliate program:', error);\r\n        return { success: false, error: error.message };\r\n    }\r\n\r\n    // Ensure user role is affiliate\r\n    const { error: roleError } = await supabaseAdmin\r\n        .from('user_profiles')\r\n        .update({ role: 'affiliate' })\r\n        .eq('id', userId);\r\n\r\n    if (roleError) {\r\n        console.error('Error updating role:', roleError);\r\n    }\r\n\r\n    return { success: true, data };\r\n}\r\n","export {getAllAffiliates as '00505e741aac111f5625ec5e1bed2f98c625a9a474'} from 'ACTIONS_MODULE0'\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"6CAAoD,OAAA,cAAA,CAAA,EAAA,aAAA,oCAC3CA,0BAAAA,qCAAAA,EAAAA,uBAAuB,YAAQ,CAAA,CAAA,IAAA,iCCEjC,SAASC,EAAyBC,CAAc,EACrD,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAQE,MAAM,CAAED,IAAK,CACvC,IAAME,EAASH,CAAO,CAACC,EAAE,CACzB,GAAsB,YAAlB,AAA8B,OAAvBE,EACT,MAAM,OAAA,cAEL,CAFK,AAAIC,MACR,CAAC,2DAA2D,EAAE,OAAOD,EAAO;AAAA,oEAAuE,CAAC,EADhJ,oBAAA,OAAA,mBAAA,eAAA,EAEN,EAEJ,CACF,0EATgBJ,2BAAAA,qCAAAA,6BCHhB,IAAA,EAAA,EAAA,CAAA,CAAA,OAGA,IAAM,EAAyB,QAAQ,GAAG,CAAC,yBAAyB,CAEvD,EAAgB,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,AAHpC,2CAGiD,EAAwB,CAC3E,KAAM,CACF,iBAAkB,GAClB,gBAAgB,CACpB,CACJ,uECPA,EAAA,EAAA,CAAA,CAAA,OAIO,eAAe,IAClB,GAAM,CAAE,MAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAA,aAAa,CACtC,IAAI,CAAC,cACL,MAAM,CAAC,CAAC;;;;;;;;QAQT,CAAC,EACA,KAAK,CAAC,aAAc,CAAE,WAAW,CAAM,UAE5C,AAAI,GACA,IADO,IACC,KAAK,CAAC,iCAAkC,GACzC,EAAE,EAGN,CACX,CAGO,eAAe,EAAqB,CAAc,CAAE,CAAa,EAEpE,GAAM,CAAE,KAAM,CAAiB,CAAE,MAAO,CAAS,CAAE,CAAG,MAAM,EAAA,aAAa,CACpE,IAAI,CAAC,cACL,MAAM,CAAC,KACP,EAAE,CAAC,CAAC,WAAW,EAAE,EAAO,UAAU,EAAE,EAAA,CAAO,EAC3C,MAAM,GAEX,GAAI,EAQA,OALA,MAAM,EAAA,EAHa,WAGA,CACd,IAAI,CAAC,iBACL,MAAM,CAAC,CAAE,KAAM,WAAY,GAC3B,EAAE,CAAC,KAAM,GAEP,CAAE,SAAS,EAAM,KAAM,CAAkB,EAIpD,IAAM,EAAa,KAAK,MAAM,GAAG,QAAQ,CAAC,IAAI,SAAS,CAAC,EAAG,IAAI,WAAW,GACpE,EAAe,CAAC,IAAI,EAAE,EAAA,CAAY,CAGlC,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAA,aAAa,CACtC,IAAI,CAAC,cACL,MAAM,CAAC,CACJ,QAAS,EACT,MAAO,EACP,YAAa,EACb,cAAe,EACf,OAAQ,SACR,gBAAiB,EACrB,GACC,MAAM,GACN,MAAM,GAEX,GAAI,EAEA,KAFO,EACP,QAAQ,KAAK,CAAC,mCAAoC,GAC3C,CAAE,SAAS,EAAO,MAAO,EAAM,OAAQ,AAAD,EAIjD,GAAM,CAAE,MAAO,CAAS,CAAE,CAAG,MAAM,EAAA,aAAa,CAC3C,IAAI,CAAC,iBACL,MAAM,CAAC,CAAE,KAAM,WAAY,GAC3B,EAAE,CAAC,KAAM,GAMd,OAJI,GACA,QADW,AACH,KAAK,CAAC,uBAAwB,GAGnC,CAAE,SAAS,OAAM,CAAK,CACjC,0CA5EsB,EAuBA,IAvBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,MAuBA,CAAA,EAAA,EAAA,uBAAA,EAAA,EAAA,6CAAA,2FC9BtB,IAAA,EAAA,EAAA,CAAA,CAAA","ignoreList":[0,1]}